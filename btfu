#!/bin/bash

PROGNAME=`basename "$0"`
REPONAME=".$PROGNAME"
HISTPATH="$REPONAME/hist"
BLOBPATH="$REPONAME/blob"
IGNORE="$REPONAME .git"

error() {
    echo "error: $*" >&2
    exit 1
}

checksum() {
    shasum "$1" | awk '{print $1}'
}

size() {
    stat "$1" | awk '{print $8}'
}

mode() {
    stat -f %p "$1"
}

ignore() {
    local filename
    for filename in $IGNORE; do
        if [ "$1" = "$filename" ]; then
            return 0
        fi
    done
    return 1
}

usage() {
    echo "usage: $PROGNAME [init]"
    exit 2
}

init() {
    if [ -e "$REPONAME" ]; then
        error "$REPONAME already exists"
    fi
    mkdir "$REPONAME" "$BLOBPATH"
}

blobpath() {
    echo "$BLOBPATH/$1"
}

backup() {
    # TODO: compress and/or encrypt blob
    local blob=`blobpath "$2"`
    if [ ! -e "$blob" ]; then
        cp "$1" "$blob"
    fi
}

walk() {
    local dirname="$1"
    local tmp=`mktemp -t "$PROGNAME".XXXXXX`
    local sha=
    for filename in `ls -A "$dirname"`; do
        if ignore $filename; then
            continue
        fi
        local path="$dirname/$filename"
        if [ -d "$path" ]; then
            type=tree
            sha=`walk "$path"`
        else
            type=blob
            sha=`checksum "$path"`
            backup "$path" "$sha"
        fi
        echo "$type" "$sha" "$filename" >>"$tmp"
    done
    sha=`checksum "$tmp"`
    backup "$tmp" "$sha"
    rm "$tmp"
    echo "$sha"
}

main() {
    set -- `getopt :h $*`
    for arg; do
        case "$arg" in
            -h)
                usage
                shift
                ;;
            --)
                shift
                ;;
        esac
    done
    [ $# -eq 0 ] && usage
    case "$1" in
        init)
            init
            ;;
        walk)
            [ ! -e "$REPONAME" ] && error "$REPONAME does not exist"
            local datetime=`date "+%Y-%m-%dT%H:%M:%SZ"`
            local id=`walk "$PWD"`
            echo "$datetime" $id >>"$HISTPATH"
            echo $id
            ;;
        hist)
            tail -r "$HISTPATH"
            ;;
        root)
            tail -1 "$HISTPATH" | awk '{print $2}'
            ;;
        blob)
            shift
            cat "`blobpath "$1"`"
            ;;
        *)
            error "invalid command: $arg"
            ;;
    esac
}

main $*
